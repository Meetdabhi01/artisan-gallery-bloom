name: React CI/CD (Optimized)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout source code
        uses: actions/checkout@v4 # Updated to v4
        with:
          fetch-depth: 1 # Only get latest commit unless you need full history
          persist-credentials: true

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4 # Updated to v4
        with:
          node-version: 20 # Use Node 20 for better performance
          cache: "npm"

      # Simplified single cache step - no separate cache action needed
      - name: ðŸ“¦ Install dependencies
        run: |
          # Use npm ci with performance flags
          npm ci --prefer-offline --no-audit --no-fund --silent
        env:
          # Speed up npm operations
          NPM_CONFIG_PREFER_OFFLINE: true
          NPM_CONFIG_AUDIT: false
          NPM_CONFIG_FUND: false
          NPM_CONFIG_PROGRESS: false

      - name: ðŸ› ï¸ Build React App (Parallel)
        run: |
          # Use all available CPU cores for build
          npm run build
        env:
          # Enable parallel processing for build tools
          NODE_OPTIONS: "--max-old-space-size=4096"
          CI: true

      - name: ðŸ” Get Commit Info (Optimized)
        id: commit_info
        run: |
          # Get both message and hash in one operation
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_HASH=$(git log -1 --pretty=format:"%h")

          # Sanitize commit message for filename
          SAFE_NAME=$(echo "$COMMIT_MSG" | sed 's/[^a-zA-Z0-9-_]//g' | cut -c1-50)

          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT

      - name: âš¡ Ultra Fast Build Processing
        run: |
          mkdir -p builds

          # Use commit hash + sanitized message for unique naming
          ZIP_NAME="${{ steps.commit_info.outputs.safe_name }}-${{ steps.commit_info.outputs.hash }}"

          echo "ðŸš€ Creating optimized build: ${ZIP_NAME}"

          # Ultra-fast zip with no compression + parallel processing
          cd dist

          # Use tar instead of zip for better performance
          time tar -cf "../builds/${ZIP_NAME}.tar" . &
          TAR_PID=$!

          # Or if you need zip format, use fastest settings
          # time zip -r -0 -q "../builds/${ZIP_NAME}.zip" . &
          # ZIP_PID=$!

          wait $TAR_PID
          cd ..

          # Quick verification
          if [ -f "builds/${ZIP_NAME}.tar" ]; then
            SIZE=$(du -sh "builds/${ZIP_NAME}.tar" | cut -f1)
            echo "âœ… SUCCESS: ${ZIP_NAME}.tar created (${SIZE})"
          else
            echo "âŒ FAILED: Archive creation failed!"
            exit 1
          fi

      - name: ðŸš€ Commit and Push (Optimized)
        run: |
          # Configure git once
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add only the builds directory
          git add builds/ --force

          # Check if there are changes and commit in one step
          if ! git diff --cached --quiet; then
            git commit -m "ðŸš€ Build: ${{ steps.commit_info.outputs.message }} (${{ steps.commit_info.outputs.hash }})"
            git push --quiet
            echo "âœ… Build committed and pushed"
          else
            echo "â„¹ï¸ No new build changes to commit"
          fi

      - name: ðŸ“Š Build Summary
        run: |
          echo "ðŸ“ Builds directory:"
          ls -lah builds/ 2>/dev/null || echo "No builds directory"

          echo "ðŸ“ˆ Build stats:"
          echo "- Commit: ${{ steps.commit_info.outputs.hash }}"
          echo "- Message: ${{ steps.commit_info.outputs.message }}"
          echo "- Node version: $(node --version)"
          echo "- Build time: $(date)
